-- UI Lib - polished, lightweight UI library
-- Features: windows, tabs, buttons, toggles, searchable dropdowns

local UI = {}

local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

local function new(class, props)
    local inst = Instance.new(class)
    if props then
        for k, v in pairs(props) do
            pcall(function() inst[k] = v end)
        end
    end
    return inst
end

local function find_existing_screenGui()
    for _, v in ipairs(CoreGui:GetChildren()) do
        if v:IsA("ScreenGui") and v.Name ~= "RobloxGui" then
            return v
        end
    end
    if LocalPlayer and LocalPlayer:FindFirstChildOfClass("PlayerGui") then
        for _, v in ipairs(LocalPlayer:FindFirstChildOfClass("PlayerGui"):GetChildren()) do
            if v:IsA("ScreenGui") and v.Name ~= "RobloxGui" then
                return v
            end
        end
    end
    return nil
end

local function create_holder()
    local existing = find_existing_screenGui()
    if existing then
        return existing
    end

    local sg = new("ScreenGui", {Name = "UI_Lib_Holder", ResetOnSpawn = false, DisplayOrder = 10000})
    if syn and syn.protect_gui then
        pcall(function() syn.protect_gui(sg) end)
    end
    local ok = pcall(function() sg.Parent = CoreGui end)
    if not ok and LocalPlayer and LocalPlayer:FindFirstChildOfClass("PlayerGui") then
        sg.Parent = LocalPlayer:FindFirstChildOfClass("PlayerGui")
    end
    return sg
end

local function style_frame(frame)
    frame.BackgroundColor3 = Color3.fromRGB(24,24,27)
    frame.BorderSizePixel = 0
    local corner = new("UICorner", {CornerRadius = UDim.new(0,10)})
    corner.Parent = frame
    local stroke = new("UIStroke", {Color = Color3.fromRGB(40,40,45), Thickness = 1, ApplyStrokeMode = Enum.ApplyStrokeMode.Border})
    stroke.Parent = frame
    local grad = new("UIGradient", {Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.fromRGB(28,28,32)), ColorSequenceKeypoint.new(1, Color3.fromRGB(18,18,21))}})
    grad.Parent = frame
end

function UI:CreateWindow(title)
    local holder = create_holder()

    local main = new("Frame", {Name = title or "Window", Size = UDim2.new(0,680,0,420), Position = UDim2.new(0.5,-340,0.5,-210)})
    style_frame(main)

    local titleBar = new("Frame", {Size = UDim2.new(1,0,0,44), BackgroundTransparency = 1, Parent = main})
    local titleLabel = new("TextLabel", {Text = title or "UI Window", Size = UDim2.new(1,0,1,0), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(230,230,230), Font = Enum.Font.GothamSemibold, TextSize = 18, Parent = titleBar})

    local left = new("Frame", {Size = UDim2.new(0,160,1,-44), Position = UDim2.new(0,0,0,44), BackgroundTransparency = 1, Parent = main})
    local tabsList = new("UIListLayout", {SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0,8)})
    tabsList.Parent = left
    left.Padding = UDim.new(0,8)

    local content = new("Frame", {Size = UDim2.new(1,-160,1,-44), Position = UDim2.new(0,160,0,44), BackgroundTransparency = 1, Parent = main})

    -- pack into holder
    main.Parent = holder

    local window = {Main = main, Tabs = {}, Content = content, Left = left}

    function window:AddTab(name)
        local tabFrame = new("ScrollingFrame", {Size = UDim2.new(1,0,1,0), BackgroundTransparency = 1, Visible = false, ScrollBarThickness = 8, Parent = content})
        local tabButton = new("TextButton", {Text = name, Size = UDim2.new(1,-16,0,36), BackgroundColor3 = Color3.fromRGB(35,35,40), TextColor3 = Color3.fromRGB(220,220,220), Font = Enum.Font.Gotham, TextSize = 14, Parent = left})
        style_frame(tabButton)

        tabButton.MouseButton1Click:Connect(function()
            for _,t in ipairs(window.Tabs) do t.Frame.Visible = false end
            tabFrame.Visible = true
        end)

        table.insert(window.Tabs, {Name = name, Frame = tabFrame, Button = tabButton})

        local list = new("UIListLayout", {Parent = tabFrame, Padding = UDim.new(0,8), SortOrder = Enum.SortOrder.LayoutOrder})

        local tabApi = {}

        function tabApi:AddButton(text, callback)
            local btn = new("TextButton", {Text = text, Size = UDim2.new(1,-24,0,36), BackgroundColor3 = Color3.fromRGB(48,48,54), TextColor3 = Color3.fromRGB(245,245,245), Font = Enum.Font.Gotham, TextSize = 14, Parent = tabFrame})
            style_frame(btn)
            btn.MouseButton1Click:Connect(function() pcall(callback) end)
            return btn
        end

        function tabApi:AddToggle(text, default, callback)
            local holderRow = new("Frame", {Size = UDim2.new(1,0,0,36), BackgroundTransparency = 1, Parent = tabFrame})
            local label = new("TextLabel", {Text = text or "Toggle", Size = UDim2.new(1,-56,1,0), Position = UDim2.new(0,8,0,0), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(230,230,230), Font = Enum.Font.Gotham, TextSize = 14, Parent = holderRow})
            local toggle = new("TextButton", {Size = UDim2.new(0,44,0,24), Position = UDim2.new(1,-52,0,6), BackgroundColor3 = Color3.fromRGB(70,70,75), Text = "", Parent = holderRow})
            style_frame(toggle)
            local circle = new("Frame", {Size = UDim2.new(0,18,0,18), Position = UDim2.new(0,6,0,3), BackgroundColor3 = Color3.fromRGB(36,36,40), Parent = toggle})
            local circCorner = new("UICorner", {CornerRadius = UDim.new(1,0)}) circCorner.Parent = circle

            local state = default and true or false
            local function refresh()
                if state then
                    toggle.BackgroundColor3 = Color3.fromRGB(85,170,100)
                    circle.Position = UDim2.new(1,-24,0,3)
                else
                    toggle.BackgroundColor3 = Color3.fromRGB(70,70,75)
                    circle.Position = UDim2.new(0,6,0,3)
                end
            end
            refresh()
            toggle.MouseButton1Click:Connect(function()
                state = not state
                refresh()
                pcall(callback, state)
            end)
            return function() return state end
        end

        function tabApi:AddDropdown(labelText, items, callback)
            items = items or {}
            local container = new("Frame", {Size = UDim2.new(1,0,0,44), BackgroundTransparency = 1, Parent = tabFrame})
            local label = new("TextLabel", {Text = labelText or "Dropdown", Size = UDim2.new(1,0,0,18), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(210,210,210), Font = Enum.Font.Gotham, TextSize = 12, Parent = container})
            local box = new("TextBox", {ClearTextOnFocus = false, Text = "", PlaceholderText = "Type to search...", Size = UDim2.new(1,0,0,26), Position = UDim2.new(0,0,0,18), BackgroundColor3 = Color3.fromRGB(40,40,44), TextColor3 = Color3.fromRGB(240,240,240), Font = Enum.Font.Gotham, TextSize = 14, Parent = container})
            style_frame(box)

            local results = new("ScrollingFrame", {Size = UDim2.new(1,0,0,120), Position = UDim2.new(0,0,0,44), CanvasSize = UDim2.new(0,0,0,0), ScrollBarThickness = 6, BackgroundTransparency = 1, Parent = container})
            local layout = new("UIListLayout", {Parent = results, Padding = UDim.new(0,6), SortOrder = Enum.SortOrder.LayoutOrder})

            local function refreshList(filter)
                filter = (filter or ""):lower()
                for i,v in ipairs(results:GetChildren()) do
                    if v:IsA("TextButton") then v:Destroy() end
                end
                local total = 0
                for _,it in ipairs(items) do
                    if filter == "" or tostring(it):lower():find(filter,1,true) then
                        local btn = new("TextButton", {Text = tostring(it), Size = UDim2.new(1,-12,0,28), BackgroundColor3 = Color3.fromRGB(40,40,44), TextColor3 = Color3.fromRGB(235,235,235), Font = Enum.Font.Gotham, TextSize = 13, Parent = results})
                        style_frame(btn)
                        btn.MouseButton1Click:Connect(function()
                            box.Text = tostring(it)
                            pcall(callback, it)
                        end)
                        total = total + 34
                    end
                end
                results.CanvasSize = UDim2.new(0,0,0,total)
            end

            box:GetPropertyChangedSignal("Text"):Connect(function()
                refreshList(box.Text)
            end)

            -- initialize
            refreshList("")

            return {
                Set = function(val) box.Text = tostring(val) end,
                Get = function() return box.Text end,
                UpdateItems = function(newItems) items = newItems refreshList(box.Text) end
            }
        end

        return tabApi
    end

    -- return the API
    return window
end

return UI
